## Part 1. Инструмент **ipcalc**

**==1.1 Сети и маски==**

Поднимаем виртуальную машину с помощью Virtual box. Берем за основу серверный диструбутив Ubuntu 20.04.6 LTS
Определяем с помощью команды ipcalc 192.167.38.54/13, устанавливая перед этим при необходимости сам ipcalc (sudo apt install ipcalc), следующую информацию
1.1.1) адрес сети 192.167.38.54/13
1.1.2) перевод маски 255.255.255.0 в префиксную и двоичную запись, /15 в обычную и двоичную, 11111111.11111111.11111111.11110000 в обычную и префиксную
1.1.3) минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4


1.1.1) Определил адрес сети 192.167.38.54/13
![linux](img/1.png)


1.1.2.а) Перевел маску 255.255.255.0 в префиксную и двоичную запись
![linux](img/2.png)


1.1.2.б) Перевел маску /15 в обычную и двоичную
![linux](img/3.png)

1.1.2.в) Перевел маску 11111111.11111111.11111111.11110000 в обычную и префиксную
![linux](img/4.png)

1.1.3.a) Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8 
![linux](img/5.png)


1.1.3.б) Минимальный и максимальный хост в сети 12.167.38.4 при масках: 11111111.11111111.00000000.00000000
![linux](img/6.png)

1.1.3.в) Минимальный и максимальный хост в сети 12.167.38.4 при масках: 255.255.254.0
![linux](img/7.png)

1.1.4.г) Минимальный и максимальный хост в сети 12.167.38.4 при масках: /4
![linux](img/8.png)

**==1.2. localhost==**

1.2. Из перечисленных IP к хосту можно обратиться со следующими IP: 127.0.0.2, 127.1.0.1
![linux](img/9.png)

**==1.3. Диапазоны и сегменты сетей==**

1.3.1)Частные IP находяться в диапазонах: 10.0.0.0 - 10.255.255.255,  172.16.0.0 - 172.31.255.255,  192.168.0.0 - 192.168.255.255

Таким образом частные IP адреса: 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255, 10.10.10.10

Таким образом публичные IP адреса: 134.43.0.2, 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1

1.3.2)Из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.10.0.2, 10.10.10.10,10.10.1.255

## Part 2. Статическая маршрутизация между двумя машинами

2.0)Вывод команды ip a на двух машинах

![linux](img/10.png)

Содержание изменённого файла etc/netplan/00-installer-config.yaml на первой машине
И Выполнение команды netplan apply

![linux](img/11.png)

Содержание изменённого файла etc/netplan/00-installer-config.yaml на второй машине
И Выполнение команды netplan apply

![linux](img/12.png)

**==2.1 Добавление статического маршрута вручную==**

Ввод команды sudo ip r add 172.24.116.8 dev enp0s3 на первой машине

![linux](img/13.png)

Ввод команды sudo ip r add 192.168.100.10 dev enp0s3на второй машине

![linux](img/14.png)


Пропинговал соединение на первой машине

![linux](img/15.png)

Пропинговал соединение на второй машине

![linux](img/16.png)

Содержание изменённого файла etc/netplan/00-installer-config.yaml на первой машине

![linux](img/17.png)

Содержание изменённого файла etc/netplan/00-installer-config.yaml на второй машине

![linux](img/18.png)


Пропинговал соединение на обоих машинах

![linux](img/19.png)


## Part 3. Утилита iperf3


**==3.1 Скорость соединения==**

8 Mbps -> 1 MB/s 100 MB/s -> 800000 kbps 1 Gbps -> 1000 Mbps


**==3.2 Утилита iperf3==**

Измеряем скорость 

![linux](img/20.png)



## Part 4. Сетевой экран

**==4.1 Утилита iptables==**

Cодержанием файлов /etc/firewall.sh для обоих машин

![linux](img/21.png)

Запуск файлов на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh

![linux](img/22.png)

Пропинговал соединение на машинах

![linux](img/23.png)

**==4.2. Утилита nmap==**

Командой ping нашел машину, которая не "пингуется"

![linux](img/24.png)

## Part 5. Статическая маршрутизация сети


**==5.1. Настройка адресов машин==**

Настроиваем конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.

На всех машинах

![linux](img/25.png)

Отчёт скринов с вызовом и выводом использованных команд.

![linux](img/26.png)


Пинг машин. На левом ping ws22 с ws21, На правом ping r1 с ws11:


![linux](img/27.png)

**==5.2 Включение переадресации IP-адресов.==**

Включение переадресации IP, выполняем команду на роутерах:

sysctl -w net.ipv4.ip_forward=1

![linux](img/28.png)


Включаем постоянную переодресацию на них же

![linux](img/29.png)

**==5.3. Установка маршрута по-умолчанию ==**

Cкрины с содержанием файла etc/netplan/00-installer-config.yaml во машинах ws11 ws22 ws21

![linux](img/30.png)

Скрины запуска команды ip r на всех машинах

![linux](img/31.png)

Пингуем c ws11 r2 

![linux](img/32.png)


**==5.4. Добавление статических маршрутов ==**

Добавляем в роутеры r1 и r2 статические маршруты в файле конфигураций. 

![linux](img/33.png)

Вызвать ip r на двух машинах

![linux](img/34.png)

Запускаем команды на ws11:
ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0

![linux](img/35.png)


**==5.5. Построение списка маршрутизаторов==**

Запустить на r1 команду дампа:
tcpdump -tnv -i enp0s8

![linux](img/36.png)

**==5.6. Использование протокола ICMP при маршрутизации==**

Запускаем на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
tcpdump -n -i eth0 icmp

Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:

![linux](img/37.png)



## Part 6. Динамическая настройка IP с помощью DHCP

Настроим d r2 в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:

![linux](img/38.png)


в файле resolv.conf прописываем nameserver 8.8.8.8.


![linux](img/39.png)


Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server. Машину ws21 перезагрузить при помощи reboot и через ip a показать, что она получила адрес. Также пропинговать ws22 с ws21.

![linux](img/40.png)

![linux](img/41.png)

![linux](img/42.png)

Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true

![linux](img/43.png)

Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты

![linux](img/44.png)

Запросить с ws21 обновление ip адреса

![linux](img/45.png)


![linux](img/46.png)

![linux](img/47.png)

## Part 7. NAT

В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным

![linux](img/48.png)

![linux](img/49.png)

Запустить веб-сервер Apache командой service apache2 start на ws22 и r1

![linux](img/50.png)

Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
1) удаление правил в таблице filter - iptables -F
2) удаление правил в таблице "NAT" - iptables -F -t nat
3) отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP

![linux](img/51.png)

Запускать файл также, как в Части 4

![linux](img/52.png)

При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1


![linux](img/53.png)

4) разрешить маршрутизацию всех пакетов протокола ICMP

![linux](img/54.png)


При запуске файла с этими правилами, ws22 должна "пинговаться" с r1

![linux](img/55.png)


5) включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
Совет: стоит подумать о маршрутизации внутренних пакетов, а также внешних пакетов с установленным соединением

6) включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети


![linux](img/56.png)


Проверить соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080)

![linux](img/57.png)


## Part 7. NAT

Запустить на r2 фаервол с правилами из Части 7

![linux](img/58.png)

Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменить строку Listen 80 на Listen localhost:80)

![linux](img/59.png)

Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21



![linux](img/60.png)

Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

![linux](img/61.png)

Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:


![linux](img/62.png)


ssh -L 8080:10.20.0.20:80 andermes@localhost - Команда открывает доступ через SSH-туннель для подключений на порт 8080 на всех интерфейсах локальной системы.

ssh -R 8080:10.20.0.10:80 andermes@localhost - Пробрасывает порт на удаленной системе в другую систему.

telnet - пользуемся им чтобы проверить сработало ли подключение в обоих предыдущих пунктах.